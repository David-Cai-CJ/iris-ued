# Azure Pipelines support for anaconda is described here:
#   https://docs.microsoft.com/en-us/azure/devops/pipelines/languages/anaconda?view=azure-devops&tabs=vs2017

jobs:

  # ------------------------------------------------------------
  #                 WINDOWS BUILD
  # ------------------------------------------------------------
  - job: Windows
    pool:
      vmImage: 'VS2017-Win2016'
    steps:
      - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
        displayName: Add conda to PATH
      
      - script: conda env create --file ./.azure/env.yml
        displayName: Create Anaconda environment

      - script: |
          call activate irisbuild
          python -m unittest discover --verbose
        displayName: Unit tests 
      
      - script: |
          call activate irisbuild
          cd installer
          python -O -m PyInstaller --clean -y --distpath=dist\executable --onedir iris-onedir.spec
        displayName: Executable build
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
        Python37:
          python.version: '3.7'

  # ------------------------------------------------------------
  #                 LINUX BUILD
  # ------------------------------------------------------------
  - job: Linux 
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Add conda to PATH
      
      - bash: conda env create --quiet --file ./.azure/env.yml
        displayName: Create Anaconda environment

      - bash: |
          source activate irisbuild
          python -m unittest discover --verbose
        displayName: Unit tests 
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
        Python37:
          python.version: '3.7'

  # ------------------------------------------------------------
  #                 MACOS BUILD
  # ------------------------------------------------------------
  - job: MacOS 
    pool:
      vmImage: 'macos-10.13'
    steps:
      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Add conda to PATH

      # On Hosted macOS, the agent user doesn't have ownership of Miniconda's installation directory/
      # We need to take ownership if we want to update conda or install packages globally
      - bash: sudo chown -R $USER $CONDA
        displayName: Take ownership of conda installation
      
      - bash: conda env create --quiet --file ./.azure/env.yml
        displayName: Create Anaconda environment

      - bash: |
          source activate irisbuild
          python -m unittest discover --verbose
        displayName: Unit tests 
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
        Python37:
          python.version: '3.7'